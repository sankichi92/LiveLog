var player;
var played = false;
var ended = false;
$('<%= escape_javascript(render('modal', song: @song)) %>')
    .on('shown.bs.modal', function () {
        player = new YT.Player(this.getElementsByClassName('player')[0], {
            events: {
                'onStateChange': function (e) {
                    if (e.data == YT.PlayerState.PLAYING && !played) {
                        ga('send', 'event', 'Videos', 'play', <%= @song.id %>);
                        played = true;
                    } else if (e.data == YT.PlayerState.ENDED && !ended) {
                        ga('send', 'event', 'Videos', 'end', <%= @song.id %>);
                        ended = true;
                    }
                }
            }
        });
    })
    .on('hidden.bs.modal', function () {
        player.stopVideo();
        this.remove();
    })
    .modal();
